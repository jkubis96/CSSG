---
title: "Benchmark - scGENE"
author: "Analyses author: Jakub Kubiś"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
  
  
---

\


```{r  include=FALSE}

# https://github.com/zpliulab/scGENA/tree/main/R%20code

# install.packages("Seurat")  
# install.packages("https://github.com/jkubis96/CSSG/raw/refs/heads/main/packages/CSSG.toolkit_0.1.0.tar.gz", repos = NULL, type = "source")


library(CSSG.toolkit)
library(Seurat)
library(openxlsx)
library(dplyr)


```




```{r  include=FALSE}



# load normalized example data
sc_project <- create_project(sparse_matrix_path = '../benchmark/data/', sparse_name = 'matrix', rows_name = 'genes', cols_name = 'barcodes', type = 'norm')

# make unique barcodes
colnames(sc_project@matrices$norm) <- make.unique(colnames(sc_project@matrices$norm))

# create seurat object
UMI <- CreateSeuratObject(counts = sc_project@matrices$norm)



######################################################################################################################################

# put into normalized
UMI@assays$RNA$data <- UMI@assays$RNA$counts
 

```


\

#### Features number


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}


UC_plot <- VlnPlot(UMI, features = c("nFeature_RNA"), ncol = )
UC_plot

```



\

##### Mitochondrial and Ribosomal genes [%]


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

UMI[['MitoPercent']] <- PercentageFeatureSet(UMI, pattern = "^MT-") + PercentageFeatureSet(UMI, pattern = "^Mt-") + PercentageFeatureSet(UMI, pattern = "^mt-")
UMI[['RiboPercent']] <- PercentageFeatureSet(UMI, pattern = "^Rps-") + PercentageFeatureSet(UMI, pattern = "^Rpl") + PercentageFeatureSet(UMI, pattern = "^RPS-") + PercentageFeatureSet(UMI, pattern = "^RPL")

MR_plot <- VlnPlot(UMI, features = c("RiboPercent", "MitoPercent"), ncol = 2)
MR_plot


```


\

#### Min-Max genes thresholds

```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

###########################################################################################################################################################

#Droplet content and QC

thresholds <- outlires(UMI@meta.data$nFeature_RNA)


thresholds$plot


```



```{r  include=FALSE}


UMI <- subset(UMI, subset = nFeature_RNA > thresholds$thresholds[1] & nFeature_RNA <= thresholds$thresholds[length(thresholds$thresholds)]
 & MitoPercent < 20)



```


\


#### Variable features


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.height=8, fig.width=10}

###########################################################################################################################################################

UMI <- FindVariableFeatures(UMI, selection.method = "vst", nfeatures = 5000, binning.method = 'equal_frequency')

# Identify the 10 most highly variable genes

top20 <- head(VariableFeatures(UMI), 20)

plot1 <- VariableFeaturePlot(UMI)

plot2 <- LabelPoints(plot = plot1, points = top20, repel = TRUE)

plot2


```


```{r  include=FALSE}


all.genes <- rownames(UMI)
UMI <- ScaleData(UMI, features = all.genes)

UMI <- RunPCA(UMI, features = VariableFeatures(object = UMI))

###########################################################################################################################################################


```



\


#### Elbow plot PCs


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

Elbow <- ElbowPlot(UMI, ndims = 50)

dims <- as.data.frame(Elbow$data$stdev)

#select the most variable reduction

dim <- dim_reuction_pcs(dims)

Elbow <- Elbow + geom_vline(xintercept = dim, color = 'red') +   geom_text(aes(x = dim + 3, y = round(max(Elbow$data$stdev)/2,0), label = paste("Dim =", dim)), color = 'red', vjust = -1)


Elbow
```


\

#### JackStraw plot PCs


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}



UMI <- JackStraw(UMI, num.replicate = 10, dims = dim)
UMI <- ScoreJackStraw(UMI, dims = 1:dim)

#Select significient PCs
jc <- as.data.frame(UMI@reductions$pca@jackstraw@overall.p.values)
jc <- jc[jc$Score < 0.05,]
dim <- as.vector(jc$PC)

plot <- JackStrawPlot(UMI, dims = dim)

plot


```


\


#### UMAP plot - Seurat clusters

```{r  include=FALSE}

UMI <- FindNeighbors(UMI, dims = dim, reduction = 'pca', nn.method="rann")
UMI <- FindClusters(UMI, resolution = 0.6, n.start = 10, n.iter = 1000)


UMI <- RunUMAP(UMI, dims = dim)


umap_plot <- DimPlot(UMI, reduction = "umap", raster = FALSE)

```


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

umap_plot

```



```{r  include=FALSE}





sc_project <- create_project_from_seurat(UMI)



```


\

#### Cells content in Seurat clusters [n]


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}




data <- bin_cell_test(p_val = 0.05, names = sc_project@names$primary, min_cells = 20)

threshold <- cell_stat_graph(data$data)

threshold



```



```{r  include=FALSE}

# 3_DEgenes.R

# # Differential expression using MAST
# BiocManager::install("MAST")
library(MAST)

markers <-FindAllMarkers(UMI,
                     only.pos = TRUE,
                     min.pct = 0.20,
                     logfc.threshold = 0.25,
                     test.use = "MAST") 


```




```{r  include=FALSE}

# 4_imputation.R

# We used SAVER method

DE_mat <- UMI@assays$RNA$data[markers$gene,]

colnames(DE_mat) <- Idents(UMI)

library(SAVER)

DE_Mat_saver <- saver(DE_mat, 
                      ncores = 6, 
                      estimates.only = TRUE)



DE_saver <- as.data.frame(DE_Mat_saver)




```


\

#### Selection of the optimal soft-thresholding power value in the analysis of gene co-occurrence networks

```{r  include=FALSE}


# 5_co_ex_net.R

# Step 5: Gene co-expression network analysis
# we build a networks based on pseudo-bulk cell types

# packages

library(Matrix)

library(dplyr)


#run GCNs

library(WGCNA)
library(flashClust)
enableWGCNAThreads()


datExpr <- as.data.frame(t(DE_saver))



# # Choose a set of soft-thresholding powers
powers = c(seq(1,10,by=1), seq(12,20, by=2));


tempdir(getwd())

# # Call the network topology analysis function for each set in turn
powerTable = list(
  data = pickSoftThreshold(
    datExpr,
    powerVector=powers,
    verbose = 100,
    networkType="signed",
    corFnc="bicor"
  )[[2]]
)

```


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.height=12, fig.width=12}



# pdf(paste0('plot.pdf'),height=9,width=10)

# Plot the results:
colors = c("blue", "red","black")
# Will plot these columns of the returned scale free analysis tables
plotCols = c(2,5,6,7)
colNames = c("Scale Free Topology Model Fit", "Mean connectivity", "mean connectivity",
             "Max connectivity");

# Get the minima and maxima of the plotted points
ylim = matrix(NA, nrow = 2, ncol = 4);
for (col in 1:length(plotCols)){
  ylim[1, col] = min(ylim[1, col], powerTable$data[, plotCols[col]], na.rm = TRUE);
  ylim[2, col] = max(ylim[2, col], powerTable$data[, plotCols[col]], na.rm = TRUE);
}

# Plot the quantities in the chosen columns vs. the soft thresholding power
par(mfcol = c(2,2));
par(mar = c(4.2, 4.2 , 2.2, 0.5))
cex1 = 0.7;

for (col in 1:length(plotCols)){
  plot(powerTable$data[,1], -sign(powerTable$data[,3])*powerTable$data[,2],
       xlab="Soft Threshold (power)",ylab=colNames[col],type="n", ylim = ylim[, col],
       main = colNames[col]);
  addGrid();

  if (col==1){
    text(powerTable$data[,1], -sign(powerTable$data[,3])*powerTable$data[,2],
         labels=powers,cex=cex1,col=colors[1]);
  } else
    text(powerTable$data[,1], powerTable$data[,plotCols[col]],
         labels=powers,cex=cex1,col=colors[1]);
  if (col==1){
    legend("bottomright", legend = 'Betacells', col = colors, pch = 20) ;
  } else
    legend("topright", legend = 'Betacells', col = colors, pch = 20) ;
}


# dev.off()

```


\


#### Gene dendrogram and module assignment

```{r  include=FALSE}



softPower=10

nSets = 1
setLabels = 'test'
shortLabels = setLabels

multiExpr <- list()
multiExpr[['test']] <- list(data=datExpr)

checkSets(multiExpr) 


# construct network
net=blockwiseConsensusModules(multiExpr, blocks = NULL,
                              maxBlockSize = 1000, 
                              randomSeed = 12345,
                              corType = "bicor", 
                              power = softPower,
                              consensusQuantile = 0.2,
                              networkType = "signed",
                              TOMType = "signed",
                              TOMDenom = "mean",
                              scaleTOMs = TRUE, scaleQuantile = 0.7,
                              sampleForScaling = TRUE, sampleForScalingFactor = 1000,
                              useDiskCache = TRUE, chunkSize = NULL,
                              deepSplit = 4,
                              pamStage=FALSE,
                              detectCutHeight = 0.999, minModuleSize = 5,
                              mergeCutHeight = 0.05,
                              saveConsensusTOMs = TRUE,
                              consensusTOMFilePattern = "ConsensusTOM-block.%b.rda")



consMEs = net$multiMEs;
moduleLabels = net$colors;

# Convert the numeric labels to color labels
moduleColors = as.character(moduleLabels)
consTree = net$dendrograms[[1]];

# module eigengenes
MEs=moduleEigengenes(multiExpr[[1]]$data, colors = moduleColors, nPC=1)$eigengenes
MEs=orderMEs(MEs)
meInfo<-data.frame(rownames(datExpr), MEs)
colnames(meInfo)[1]= "SampleID"
# View(moduleColors)
# intramodular connectivity
KMEs<-signedKME(datExpr, MEs,outputColumnName = "kME",corFnc = "bicor")

# compile into a module metadata table
geneInfo=as.data.frame(cbind(colnames(datExpr),moduleColors, KMEs))

# how many modules did we get?
nmodules <- length(unique(moduleColors))

# merged gene symbol column
colnames(geneInfo)[1]= "GeneSymbol"
colnames(geneInfo)[2]= "Initially.Assigned.Module.Color"


PCvalues=MEs

```


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.height=10, fig.width=10}

# pdf("SignedDendro.pdf",height=5, width=8)
plotDendroAndColors(consTree, moduleColors, "Module colors", dendroLabels = FALSE, hang = 0.03, addGuide = TRUE, guideHang = 0.05)
# dev.off()


```








```{r  include=FALSE}


head(MEs)


cell_module_assignment <- apply(MEs, 1, function(x) colnames(MEs)[which.max(x)])

cell_assignment <- data.frame(SampleID = rownames(MEs), AssignedModule = cell_module_assignment)


cell_assignment$clusters <- as.numeric(as.factor(cell_assignment$AssignedModule))

```



```{r  include=FALSE}


Idents(UMI) <- cell_assignment$clusters


```


\


#### UMAP Plot – Clusters from scGENE Approach Visualized with Seurat-Based Dimensionality Reduction (UMAP/PCA)


```{r  include=FALSE}



umap_plot <- DimPlot(UMI, reduction = "umap", raster = FALSE)

svg("umap_scGENE.svg", width = 10, height = 8) 

umap_plot

dev.off()

```


```{r include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

plotly::ggplotly(umap_plot)


```






```{r  include=FALSE}





sc_project <- create_project_from_seurat(UMI)



```


\

#### Cells content in scGENE clusters [n]


```{r  include=FALSE}




data <- bin_cell_test(p_val = 0.05, names = sc_project@names$primary, min_cells = 20)

threshold <- cell_stat_graph(data$data)


svg("threshold_scGENE.svg", width = 8, height = 6) 

threshold

dev.off()

```



```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

threshold


```

\

#### Markers table

\

```{r   include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}


# cluster markers selection - wilcox

library(MAST)

markers <-FindAllMarkers(UMI,
                     only.pos = TRUE,
                     min.pct = 0.10,
                     logfc.threshold = 0.10,
                     test.use = "MAST") 


write.csv(markers, 'scGENE_cluster_markers.csv', quote = FALSE)


DT::datatable(markers, filter = "top", options = list(pageLength = 10))

```

\

#### Top 2 markers for scGENE clusters

```{r   include=FALSE}



library(dplyr)

top <- markers %>%
  group_by(cluster) %>%
  arrange(cluster, desc(avg_log2FC), p_val) %>%  
  slice_head(n = 2)

sc_project@names$subtypes <- sc_project@names$primary



plot <- marker_heatmap(sc_project, type = 'subtypes', markers = top$gene, angle_col = 270, fontsize_row = 7, fontsize_col = 7, font_labels = 8, clustering_method = 'complete', x_axis = 'Cells', y_axis = 'Genes [log(CPM +1)]')

svg("heat_scGENE.svg", width = 8, height = 8) 

plot

dev.off()


```


```{r   include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}


plot

```