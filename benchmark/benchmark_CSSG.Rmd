---
title: "Benchmark - CSSG"
author: "Analyses author: Jakub Kubiś"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

\



```{r  include=FALSE}


# install.packages("Seurat")  
# install.packages("https://github.com/jkubis96/CSSG/raw/refs/heads/main/packages/CSSG.toolkit_0.1.0.tar.gz", repos = NULL, type = "source")


library(CSSG.toolkit)
library(Seurat)
library(openxlsx)
library(dplyr)


```



```{r  include=FALSE}



# load normalized example data
sc_project <- create_project(sparse_matrix_path = '../benchmark/data/', sparse_name = 'matrix', rows_name = 'genes', cols_name = 'barcodes', type = 'norm')

# make unique barcodes
colnames(sc_project@matrices$norm) <- make.unique(colnames(sc_project@matrices$norm))

# create seurat object
UMI <- CreateSeuratObject(counts = sc_project@matrices$norm)



######################################################################################################################################

# put into normalized
UMI@assays$RNA$data <- UMI@assays$RNA$counts
 

```


\

#### Features number


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}


UC_plot <- VlnPlot(UMI, features = c("nFeature_RNA"), ncol = )
UC_plot

```



\

##### Mitochondrial and Ribosomal genes [%]


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

UMI[['MitoPercent']] <- PercentageFeatureSet(UMI, pattern = "^MT-") + PercentageFeatureSet(UMI, pattern = "^Mt-") + PercentageFeatureSet(UMI, pattern = "^mt-")
UMI[['RiboPercent']] <- PercentageFeatureSet(UMI, pattern = "^Rps-") + PercentageFeatureSet(UMI, pattern = "^Rpl") + PercentageFeatureSet(UMI, pattern = "^RPS-") + PercentageFeatureSet(UMI, pattern = "^RPL")

MR_plot <- VlnPlot(UMI, features = c("RiboPercent", "MitoPercent"), ncol = 2)
MR_plot


```


\

#### Min-Max genes thresholds

```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

###########################################################################################################################################################

#Droplet content and QC

thresholds <- outlires(UMI@meta.data$nFeature_RNA)


thresholds$plot


```



```{r  include=FALSE}


UMI <- subset(UMI, subset = nFeature_RNA > thresholds$thresholds[1] & nFeature_RNA <= thresholds$thresholds[length(thresholds$thresholds)]
 & MitoPercent < 20)



```


\


#### Variable features


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.height=8, fig.width=10}

###########################################################################################################################################################

UMI <- FindVariableFeatures(UMI, selection.method = "vst", nfeatures = 5000, binning.method = 'equal_frequency')

# Identify the 10 most highly variable genes

top20 <- head(VariableFeatures(UMI), 20)

plot1 <- VariableFeaturePlot(UMI)

plot2 <- LabelPoints(plot = plot1, points = top20, repel = TRUE)

plot2


```


```{r  include=FALSE}


all.genes <- rownames(UMI)
UMI <- ScaleData(UMI, features = all.genes)

UMI <- RunPCA(UMI, features = VariableFeatures(object = UMI))

###########################################################################################################################################################


```



\


#### Elbow plot PCs


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

Elbow <- ElbowPlot(UMI, ndims = 50)

dims <- as.data.frame(Elbow$data$stdev)

#select the most variable reduction

dim <- dim_reuction_pcs(dims)

Elbow <- Elbow + geom_vline(xintercept = dim, color = 'red') +   geom_text(aes(x = dim + 3, y = round(max(Elbow$data$stdev)/2,0), label = paste("Dim =", dim)), color = 'red', vjust = -1)


Elbow
```


\

#### JackStraw plot PCs


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

###########################################################################################################################################################

UMI <- JackStraw(UMI, num.replicate = 10, dims = dim)
UMI <- ScoreJackStraw(UMI, dims = 1:dim)

#Select significient PCs
jc <- as.data.frame(UMI@reductions$pca@jackstraw@overall.p.values)
jc <- jc[jc$Score < 0.05,]
dim <- as.vector(jc$PC)

plot <- JackStrawPlot(UMI, dims = dim)

plot


```


\


#### UMAP plot - Seurat clusters

```{r  include=FALSE}

UMI <- FindNeighbors(UMI, dims = dim, reduction = 'pca', nn.method="rann")
UMI <- FindClusters(UMI, resolution = 0.6, n.start = 10, n.iter = 1000)


UMI <- RunUMAP(UMI, dims = dim)


umap_plot <- DimPlot(UMI, reduction = "umap", raster = FALSE)

```


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

umap_plot

```



```{r  include=FALSE}





sc_project <- create_project_from_seurat(UMI)



```





```{r  include=FALSE}


markers_class = read.xlsx('../markers/non_canonical.xlsx', sheet = 1)
markers_subclass = read.xlsx('../markers/non_canonical.xlsx', sheet = 2)




# cluster markers selection - variance
sc_project <- heterogeneity_select_variance(sc_project = sc_project, heterogeneity_factor = 80, max_genes = 50, min_occ = 5, min_exp = 0.3, rep_factor = 0.5, mito_content = FALSE)





```




```{r  include=FALSE}




sc_project <- subclass_naming(sc_project = sc_project, class_markers = markers_class, subclass_markers = markers_subclass, species = 'Homo sapiens', chunk_size = 5000)




```


\

#### Cells content in subclasses (primary clusters with names) [n]


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}




data <- bin_cell_test(p_val = 0.05, names = sc_project@names$subclass, min_cells = 20)

threshold <- cell_stat_graph(data$data)

threshold


```


\


```{r  include=FALSE}


sc_project <- CSSG_markers(sc_project = sc_project, max_combine = 1000, loss_val = 0.05)



sc_project <- subtypes_naming(sc_project = sc_project, markers_class = markers_class, markers_subclass = markers_subclass, species = 'Homo sapiens') 


```

\

#### Cells content in subtypes [n]


```{r  include=FALSE}


thr_data <- bin_cell_test(p_val = 0.05, names = sc_project@names$repaired, min_cells = 10)

threshold <- cell_stat_graph(thr_data$data, include_ns = TRUE)


svg("threshold_cssg.svg", width = 8, height = 15) 

threshold

dev.off()

```

```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.height=10, fig.width=10}

threshold


```





```{r  include=FALSE}

###########################################################################################################################################################
UMI2 <- UMI

# UMI2@assays$RNA$data <- as(Matrix(as.matrix(DE_saver), sparse = TRUE), "dgCMatrix")
  
  
Idents(UMI2) <- sc_project@names$repaired$renamed_idents


select_list <- thr_data$data$names[thr_data$data$test %in% c("Good marked types", "Renamed")]

UMI2 <- subset(UMI2, idents = select_list)


```



\


#### UMAP Plot – subtypes from CSSG Approach Visualized with Seurat-Based Dimensionality Reduction (UMAP/PCA)


```{r  include=FALSE}

library(plotly)

UMI2 <- RunUMAP(UMI2, dims = dim)


umap_plot <- DimPlot(UMI2, reduction = "umap", raster = FALSE)


svg("umap_cssg.svg", width = 15, height = 8) 

umap_plot

dev.off()

```



```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.height=7, fig.width=14}


plotly::ggplotly(umap_plot)

```





```{r  include=FALSE}


select_list <- thr_data$data$names[thr_data$data$test %in% c("Good marked types", "Renamed")]


sub_sc_project <- subset_project(sc_project = sc_project, type = 'subtypes', select_list = select_list)


```


\

#### Markers table


```{r  include=FALSE}


# cluster markers selection - wilcox

sub_sc_project <- get_cluster_stats(sc_project = sub_sc_project, type = 'subtypes', only_pos = TRUE, min_pct = 0.05)


markers <- sub_sc_project@metadata$subtypes_markers

write.csv(markers, 'cssg_subtypes_markers.csv', quote = FALSE)



```



```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}


DT::datatable(markers, filter = "top", options = list(pageLength = 5))

```



\

#### Top markers for subtypes - included in cell names


```{r  include=FALSE}




markers <- get_names_markers(sub_sc_project, type = 'subtypes') 


plot <- marker_heatmap(sub_sc_project, type = 'subtypes', markers = markers, angle_col = 270, fontsize_row = 7, fontsize_col = 7, font_labels = 8, clustering_method = 'complete', x_axis = 'Cells', y_axis = 'Genes [log(CPM +1)]')


svg("heat_cssg.svg", width = 12, height = 10) 

plot

dev.off()

```



```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.height=12, fig.width=12}



plot

```

