---
title: "Benchmark - conCluster"
author: "Analyses author: Jakub Kubiś"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

\




```{r  include=FALSE}


# install.packages("Seurat")  
# install.packages("https://github.com/jkubis96/CSSG/raw/refs/heads/main/packages/CSSG.toolkit_0.1.0.tar.gz", repos = NULL, type = "source")


library(CSSG.toolkit)
library(Seurat)
library(openxlsx)
library(dplyr)


```




```{r  include=FALSE}



# load normalized example data
sc_project <- create_project(sparse_matrix_path = '../benchmark/data/', sparse_name = 'matrix', rows_name = 'genes', cols_name = 'barcodes', type = 'norm')

# make unique barcodes
colnames(sc_project@matrices$norm) <- make.unique(colnames(sc_project@matrices$norm))

# create seurat object
UMI <- CreateSeuratObject(counts = sc_project@matrices$norm)



######################################################################################################################################

# put into normalized
UMI@assays$RNA$data <- UMI@assays$RNA$counts
 

```


\

#### Features number


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}


UC_plot <- VlnPlot(UMI, features = c("nFeature_RNA"), ncol = )
UC_plot

```



\

##### Mitochondrial and Ribosomal genes [%]


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

UMI[['MitoPercent']] <- PercentageFeatureSet(UMI, pattern = "^MT-") + PercentageFeatureSet(UMI, pattern = "^Mt-") + PercentageFeatureSet(UMI, pattern = "^mt-")
UMI[['RiboPercent']] <- PercentageFeatureSet(UMI, pattern = "^Rps-") + PercentageFeatureSet(UMI, pattern = "^Rpl") + PercentageFeatureSet(UMI, pattern = "^RPS-") + PercentageFeatureSet(UMI, pattern = "^RPL")

MR_plot <- VlnPlot(UMI, features = c("RiboPercent", "MitoPercent"), ncol = 2)
MR_plot


```


\

#### Min-Max genes thresholds

```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

###########################################################################################################################################################

#Droplet content and QC

thresholds <- outlires(UMI@meta.data$nFeature_RNA)


thresholds$plot


```



```{r  include=FALSE}


UMI <- subset(UMI, subset = nFeature_RNA > thresholds$thresholds[1] & nFeature_RNA <= thresholds$thresholds[length(thresholds$thresholds)]
 & MitoPercent < 20)



```


\


#### Variable features


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE, fig.height=8, fig.width=10}

###########################################################################################################################################################

UMI <- FindVariableFeatures(UMI, selection.method = "vst", nfeatures = 5000, binning.method = 'equal_frequency')

# Identify the 10 most highly variable genes

top20 <- head(VariableFeatures(UMI), 20)

plot1 <- VariableFeaturePlot(UMI)

plot2 <- LabelPoints(plot = plot1, points = top20, repel = TRUE)

plot2


```


```{r  include=FALSE}


all.genes <- rownames(UMI)
UMI <- ScaleData(UMI, features = all.genes)

UMI <- RunPCA(UMI, features = VariableFeatures(object = UMI))

###########################################################################################################################################################


```



\


#### Elbow plot PCs


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

Elbow <- ElbowPlot(UMI, ndims = 50)

dims <- as.data.frame(Elbow$data$stdev)

#select the most variable reduction

dim <- dim_reuction_pcs(dims)

Elbow <- Elbow + geom_vline(xintercept = dim, color = 'red') +   geom_text(aes(x = dim + 3, y = round(max(Elbow$data$stdev)/2,0), label = paste("Dim =", dim)), color = 'red', vjust = -1)


Elbow
```


\

#### JackStraw plot PCs


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}



UMI <- JackStraw(UMI, num.replicate = 10, dims = dim)
UMI <- ScoreJackStraw(UMI, dims = 1:dim)

#Select significient PCs
jc <- as.data.frame(UMI@reductions$pca@jackstraw@overall.p.values)
jc <- jc[jc$Score < 0.05,]
dim <- as.vector(jc$PC)

plot <- JackStrawPlot(UMI, dims = dim)

plot


```


\


#### UMAP plot - Seurat clusters

```{r  include=FALSE}

UMI <- FindNeighbors(UMI, dims = dim, reduction = 'pca', nn.method="rann")
UMI <- FindClusters(UMI, resolution = 0.6, n.start = 10, n.iter = 1000)


UMI <- RunUMAP(UMI, dims = dim)


umap_plot <- DimPlot(UMI, reduction = "umap", raster = FALSE)

```


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

umap_plot

```



```{r  include=FALSE}





sc_project <- create_project_from_seurat(UMI)



```


\

#### Cells content in Seurat clusters [n]


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}




data <- bin_cell_test(p_val = 0.05, names = sc_project@names$primary, min_cells = 20)

threshold <- cell_stat_graph(data$data)

threshold



```






```{r  include=FALSE}

# part of code created for conCLuster approach

UMI <- RunTSNE(UMI, dims = dim)

set.seed(123)
tsne_coords <- Embeddings(UMI, "tsne")
num_clusters <- 10
clustering_results <- replicate(10, kmeans(tsne_coords, centers = num_clusters)$cluster)

binary_matrix <- do.call(cbind, lapply(1:ncol(clustering_results), function(i) {
  table(rownames(tsne_coords), clustering_results[, i])
}))

library(ConsensusClusterPlus)

# Consensus clustering
consensus_result <- ConsensusClusterPlus(t(binary_matrix), maxK = 10, reps = 50, pItem = 1, 
                                         pFeature = 1, clusterAlg = "hc", distance = "euclidean")


library(clusterCrit) 

k <- c()
inx <- c()
for (i in 4:num_clusters) {
  
  print(i)
  cluster_assignments <- consensus_result[[i]]$consensusClass
  ch_index <- intCriteria(tsne_coords, as.integer(cluster_assignments), "Calinski_Harabasz")$calinski_harabasz
  
  k <- c(k,i)
  inx <- c(inx, ch_index)

}


inx_df <- data.frame(list('k' = k, 'inx' = inx))
inx_df <- inx_df[order(-inx_df$inx), ]



clusters <- consensus_result[[inx_df$k[1]]]$consensusClass


Idents(UMI) <- unname(clusters)[match(names(Idents(UMI)), names(clusters))]

```




\


#### UMAP Plot – Clusters from conCluster Approach Visualized with Seurat-Based Dimensionality Reduction (UMAP/PCA)

```{r  include=FALSE}



umap_plot <- DimPlot(UMI, reduction = "umap", raster = FALSE)

svg("umap_conCluster.svg", width = 10, height = 8) 

umap_plot

dev.off()

```


```{r include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

plotly::ggplotly(umap_plot)


```




```{r  include=FALSE}





sc_project <- create_project_from_seurat(UMI)



```


\

#### Cells content in conCluster clusters [n]


```{r  include=FALSE}




data <- bin_cell_test(p_val = 0.05, names = sc_project@names$primary, min_cells = 20)

threshold <- cell_stat_graph(data$data)

svg("threshold_conCluster.svg", width = 8, height = 6) 

threshold

dev.off()

```



```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

threshold


```

\

#### Markers table

\

```{r   include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}


# cluster markers selection - wilcox

library(MAST)

markers <-FindAllMarkers(UMI,
                     only.pos = TRUE,
                     min.pct = 0.10,
                     logfc.threshold = 0.10,
                     test.use = "MAST") 


write.csv(markers, 'conCluster_cluster_markers.csv', quote = FALSE)


DT::datatable(markers, filter = "top", options = list(pageLength = 10))

```

\

#### Top 2 markers for conCluster clusters

```{r   include=FALSE}


library(dplyr)

top <- markers %>%
  group_by(cluster) %>%
  arrange(cluster, desc(avg_log2FC), p_val) %>%  
  slice_head(n = 2)

sc_project@names$subtypes <- sc_project@names$primary



plot <- marker_heatmap(sc_project, type = 'subtypes', markers = top$gene, angle_col = 270, fontsize_row = 7, fontsize_col = 7, font_labels = 8, clustering_method = 'complete', x_axis = 'Cells', y_axis = 'Genes [log(CPM +1)]')


svg("heat_conCluster.svg", width = 8, height = 8) 

plot

dev.off()

```


```{r   include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}


plot

```
