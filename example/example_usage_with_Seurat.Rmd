---
title: "Example usage with Seurat"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

\



```{r  include=FALSE}


# Install required packages

install.packages("Seurat")
install.packages("remotes")

remotes::install_url(
  "https://github.com/jkubis96/CSSG/raw/refs/heads/main/packages/CSSG.toolkit_0.1.2.tar.gz",
  dependencies = TRUE
)


library(CSSG.toolkit)
library(Seurat)
library(openxlsx)
library(dplyr)


```



```{r  include=FALSE}



# load normalized example data
sc_project <- create_project(sparse_matrix_path = '../benchmark/data/', sparse_name = 'matrix', rows_name = 'genes', cols_name = 'barcodes', type = 'norm')

# make unique barcodes
colnames(sc_project@matrices$norm) <- make.unique(colnames(sc_project@matrices$norm))

# create seurat object
UMI <- CreateSeuratObject(counts = sc_project@matrices$norm)



######################################################################################################################################

# put into normalized (example data is after normalization)
UMI@assays$RNA$data <- UMI@assays$RNA$counts
 
# if count data omit this step ^ and conduct normalization eg. with Seurat

```



```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}


UC_plot <- VlnPlot(UMI, features = c("nFeature_RNA"), ncol = )
UC_plot

```



```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

UMI[['MitoPercent']] <- PercentageFeatureSet(UMI, pattern = "^MT-") + PercentageFeatureSet(UMI, pattern = "^Mt-") + PercentageFeatureSet(UMI, pattern = "^mt-")
UMI[['RiboPercent']] <- PercentageFeatureSet(UMI, pattern = "^Rps-") + PercentageFeatureSet(UMI, pattern = "^Rpl") + PercentageFeatureSet(UMI, pattern = "^RPS-") + PercentageFeatureSet(UMI, pattern = "^RPL")

MR_plot <- VlnPlot(UMI, features = c("RiboPercent", "MitoPercent"), ncol = 2)
MR_plot


```




```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}



#Droplet content and QC

thresholds <- outlires(UMI@meta.data$nFeature_RNA)


thresholds$plot


```



```{r  include=FALSE}


UMI <- subset(UMI, subset = nFeature_RNA > thresholds$thresholds[1] & nFeature_RNA <= thresholds$thresholds[length(thresholds$thresholds)]
 & MitoPercent < 20)



```



```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

###########################################################################################################################################################

UMI <- FindVariableFeatures(UMI, selection.method = "vst", nfeatures = 2500, binning.method = 'equal_frequency')

# Identify the 10 most highly variable genes

top20 <- head(VariableFeatures(UMI), 20)

plot1 <- VariableFeaturePlot(UMI)

plot2 <- LabelPoints(plot = plot1, points = top20, repel = TRUE)

plot2


```




```{r  include=FALSE}


all.genes <- rownames(UMI)
UMI <- ScaleData(UMI, features = all.genes)

UMI <- RunPCA(UMI, features = VariableFeatures(object = UMI))


```




```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

Elbow <- ElbowPlot(UMI, ndims = 50)

dims <- as.data.frame(Elbow$data$stdev)

#select the most variable reduction

dim <- dim_reuction_pcs(dims)

Elbow <- Elbow + geom_vline(xintercept = dim, color = 'red') +   geom_text(aes(x = dim + 3, y = round(max(Elbow$data$stdev)/2,0), label = paste("Dim =", dim)), color = 'red', vjust = -1)

Elbow

```




```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

###########################################################################################################################################################

UMI <- JackStraw(UMI, num.replicate = 10, dims = dim)
UMI <- ScoreJackStraw(UMI, dims = 1:dim)

#Select significient PCs
jc <- as.data.frame(UMI@reductions$pca@jackstraw@overall.p.values)
jc <- jc[jc$Score < 0.05,]
dim <- as.vector(jc$PC)

plot <- JackStrawPlot(UMI, dims = dim)

plot


```



```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

UMI <- FindNeighbors(UMI, dims = dim, reduction = 'pca', nn.method="rann")
UMI <- FindClusters(UMI, resolution = 0.6, n.start = 10, n.iter = 1000)


UMI <- RunUMAP(UMI, dims = dim)


umap_plot <- DimPlot(UMI, reduction = "umap", raster = FALSE)

umap_plot

```



```{r  include=FALSE}


# run CSSG.toolkit project from Seurat project
sc_project <- create_project_from_seurat(UMI)



```




## Cluster naming


#### Cluster markers and CSSG preparing


```{r  include=FALSE}

# load markers for 
markers_class = read.xlsx('../markers/non_canonical.xlsx', sheet = 1)
markers_subclass = read.xlsx('../markers/non_canonical.xlsx', sheet = 2)


# get markers for subclass naming
sc_project <- get_cluster_stats(sc_project = sc_project, type = 'primary', only_pos = TRUE)



# select markers for subclass naming
sc_project <- namign_genes_selection(sc_project, type = 'primary', top_n = 25,
                              p_val = 0.05, select_stat = "p_val",
                              mito_content = FALSE, ribo_content = FALSE)



# there are two options for subtypes naming with CSS based on variance or cluster-specific markers

# select markers for CSSG algorithm based on inside variance
  
sc_project <- heterogeneity_select_variance(sc_project = sc_project, 
                                                          heterogeneity_factor = 0.80, 
                                                          max_genes = 1000, 
                                                          min_occ = 5, 
                                                          min_exp = 0.1, 
                                                          rep_factor = 0.2, 
                                                          mito_content = FALSE)
# or

# select markers for CSSG algorithm based on cluster-specific markers calcualted with get_cluster_stats()

sc_project <- heterogeneity_select_specificity(sc_project = sc_project, 
                                                             type = 'primary', 
                                                             heterogeneity_factor = 0.80, 
                                                             p_val =  0.05, 
                                                             max_genes =  1000, 
                                                             select_stat = 'p_val',  
                                                             min_occ = 5, 
                                                             mito_content = FALSE)




```


\

#### Class & Subclasses - predefined marker cells naming


```{r  include=FALSE}


sc_project <- subclass_naming(sc_project = sc_project, class_markers = markers_class, subclass_markers <- markers_subclass, species = 'Homo sapiens', chunk_size = 5000)


```


#### Class & Subclasses - predefined marker cells naming


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}


data <- bin_cell_test(p_val = 0.05, names = sc_project@names$subclass, min_cells = 20)

threshold <- cell_stat_graph(data$data)

threshold



```


\


#### CSSG approach


```{r  include=FALSE}


# markers combinations selection with CSSG
sc_project <- CSSG_markers(sc_project = sc_project, max_combine = 1000, loss_val = 0.05)


# subtypes creating
sc_project <- subtypes_naming(sc_project = sc_project, markers_class = markers_class, markers_subclass = markers_subclass, species = 'Homo sapiens') 


```

\


#### Genes per cell thresholds - plot


```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}





thr_data <- bin_cell_test(p_val = 0.05, names = sc_project@names$repaired, min_cells = 10)

threshold <- cell_stat_graph(thr_data$data, include_ns = FALSE)


threshold



```




#### Seurat data reduction and subtypes visualization on Seurat dimensional reduced (PCA/UMAP) data with UMAP plot


```{r  include=FALSE}


# copy Seuratproject for new data implementation

UMI2 <- UMI

  
Idents(UMI2) <- sc_project@names$repaired$renamed_idents


select_list <- thr_data$data$names[thr_data$data$test %in% c("Good marked types", "Renamed")]

UMI2 <- subset(UMI2, idents = select_list)


```




```{r  include=TRUE, echo=FALSE, warning=FALSE, message=FALSE}

# run UMAP with CSSG subtypes

umap_plot <- DimPlot(UMI2, reduction = "umap", raster = FALSE)

umap_plot

```



#### Reduction of data to significant cell subtypes



```{r  include=FALSE}


select_list <- thr_data$data$names[thr_data$data$test %in% c("Good marked types", "Renamed")]


sub_sc_project <- subset_project(sc_project = sc_project, type = 'subtypes', select_list = select_list)

```



#### Data returning


```{r  include=FALSE}



data <- get_data(sc_project = sub_sc_project, type = 'subtypes', data = 'norm')


data_avg <- get_avg_data(sc_project = sub_sc_project, type = 'subtypes', data = 'norm')


```



#### Selection of subtypes markers


```{r  include=FALSE}


# cluster markers selection - wilcox

sub_sc_project <- get_cluster_stats(sc_project = sub_sc_project, type = 'subtypes', only_pos = TRUE, min_pct = 0.05)


markers <- sub_sc_project@metadata$subtypes_markers

library(dplyr)

markers5 <- markers %>%
  group_by(cluster) %>%
  arrange(cluster, desc(esm), p_val, desc(avg_logFC), desc(pct_occurrence)) %>%  
  slice_head(n = 5)

write.csv(markers5, 'top5.csv', quote = FALSE)

```



#### Visualization of top markers used for subclass and subtypes creation


```{r  include=FALSE}


markers <- get_names_markers(sub_sc_project, type = 'subtypes') 


plot <- marker_heatmap(sub_sc_project, type = 'subtypes', markers = markers, angle_col = 270, fontsize_row = 7, fontsize_col = 7, font_labels = 8, clustering_method = 'complete', x_axis = 'Cells', y_axis = 'Genes [log(CPM +1)]', scale = F)


plot
```

```{r  include=FALSE}



plot <- marker_heatmap(sub_sc_project, type = 'subtypes', markers = markers, angle_col = 270, fontsize_row = 7, fontsize_col = 7, font_labels = 8, clustering_method = 'complete', x_axis = 'Cells', y_axis = 'Scaled(Genes [log(CPM +1)])', scale  = T)


plot
```
